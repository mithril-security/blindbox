# Attestation

??? abstract "Learn more about Confidential Computing ðŸ“–" 

	+ [Our intro to Confidential Computing](../getting-started/confidential_computing.md)
	+ [Discover the Confidential Computing ecosystem](../concepts/ecosystem.md)
	+ [A guide to AMD SEV](../concepts/amd-sev.md)
	+ [Confidential Computing Explained](https://confidential-computing-explained.mithrilsecurity.io/en/latest/), a hands-on course to learn how enclaves work and how to create your own mini-KMS

The aim of this guide is to go over [attestation](https://blindbox.mithrilsecurity.io/en/latest/docs/getting-started/confidential_computing/) in more detail and discuss how it is implemented it in BlindBox.

!!! warning "Disclaimer"

	We currently only support the deployment of BlindBoxes on AMD SEV-SNP confidential VMs with Azure, but we plan to support other platforms in future releases.

## What do we attest?

The **Microsoft Azure Attestation service** attests the **validity of the AMD SEV-SNP report** by verifying the reports hardware-derived signature.

**BlindBox** attests that the **JWT attestation token response** we get back from the Microsoft Azure Attestation service has **not been tampered with** by verifying the tokenâ€™s signature, validity and some runtime information.

BlindBox then uses the information provided in JWT attestation response to verify that:

+ We are **communicating** with a genuine **AMD SEV-SNP confidential VM**.
+ We are **communicating** with a **genuine Azure-compliant VM**.
+ The VM is **running** in **production mode** and *not* debug mode.

## The attestation workflow

Letâ€™s walk through the whole life cycle of the attestation process from the moment an end user starts a new connection with a SaaS application deployed with BlindBox.

1. The end user queries the application. This triggers a new connection request, which in turn triggers the attestation process. 
2. BlindBox requests attestation using the Microsoft attestation library.
3. The Microsoft attestation library requests an attestation report from AMD SEV-SNP. This report is signed by a hardware-derived key. For more details about this report [here](#amd-sev-snp-attestation-report).
4. This report is then sent to the Microsoft Azure Attestation (MAA) Service.
5. MAA verifies the signature on this report, confirming that it was generated by genuine AMD SEV-SNP hardware. If this check is successful, MAA returns a signed JWT attestation token containing details about the SEV-SNP environment to the Microsoft attestation library. For more details about this report [here](#maa-attestation-token).
6. This token is then returned to BlindBox.
7. BlindBox verifies the validity of this token before using the report to perform the checks detailed above.
8. BlindBox returns an error if any of these checks are unsuccessful. If not, the end user will successfully connect to the BlindBox application and their query will be processed.

## What happens when attestation fails?

Let's take a look at what happens if the attestation process is not successful.

For an **interactive demo of the attestation process**, check out our [**Gradio demo**](https://huggingface.co/spaces/mithril-security/BlindBox).

### Non-compliant Azure VM

*Query:*
```python
res = requests.post(url=f"http://{CONFIDENTIAL_VM_IP_ADDRESS}/generate", json={"input_text": "def print_hello_world():"})
```

*Response:*
```bash
$ __main__.NonCompliantUvm: Attestation validation failed (non-compliant uvm). Exiting.
```

### Debug mode

*Query:*
```python
res = requests.post(url=f"http://{CONFIDENTIAL_VM_IP_ADDRESS}/generate", json={"input_text": "def print_hello_world():"})
```

*Response:*
```bash
$ __main__.DebugMode: Attestation validation failed (enclave is in debug mode). Exiting.
```

## Who is responsible for attestation?

The attestation process is an **automated** process managed by BlindBox which also replies on a couple of trusted dependencies.

âœ… Attestation is set-up to be performed by default whenever an end user starts a new connection to a BlindBox- from a customer perspective, no additional actions are required.

â›” If any of our attestation checks fail, the end user will be unable to connect to the BlindBox.

ðŸ“œ The BlindBox attestation process relies on the enclave hardware provider such as AMD to generate and sign attestation reports.

ðŸ•µ The process also relies on either a service provided by the hardware provider or an independent trusted enforcer such as the Microsoft Attestation Service to verify and sign this report to vouch for its validty.

## Conclusions

This concludes our advanced guide into how attestation is implemented in BlindBox.

We have seen:

+ What details are verified during the attestation process
+ The life cycle of the attestation process
+ What to expect if attestation fails
+ The role of each concerned party in attestation

If you have any further questions, please get in touch! 
